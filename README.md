# Godot-Nim v4.1

## Notice

A [successor project](https://github.com/godot-nim) is currently underway. Future updates will be made to this project.

This repository may be operated as a mirror of the said project, but this has not been decided yet.

## Description

It enable us to work godot-4.x with Nim.

Based on **[godot-cpp 4.1 stable](https://github.com/godotengine/godot-cpp/tree/godot-4.1-stable)**

## How to use

* See **[test/](https://github.com/panno8M/godot-nim/tree/main/test)** to get an overview of the binding interface.
* There is a nim implementation of Dodge the Creeps! at **[demo/](https://github.com/panno8M/godot-nim/tree/main/demo)**.

### Known Issues

#### Caused in this library

* Initial loading of the extension fails
  > Initialization of the extension fails the first time. Reloading solves the problem.

#### Caused in Engine

* AudioStreamPlayer causes a leak in the resources used by this node. We have seen this happen in the demo project.

## Features

This project is in the early stages of development and some features are not yet operational.

### ðŸŸ¢Available

#### Godot (Editor/GDScript) Side

See **[GodotSideTester](https://github.com/panno8M/godot-nim/tree/main/test/src/godotSideTester.nim)** and **[tester.gd](https://github.com/panno8M/godot-nim/tree/main/test/tester.gd)**

* Add defined Extension-Class Node into scene
* Instantiate Extension-Class
* Call Extension-Class method
* Use Extension-Class property
* Receive/Emit Extension-Class signal

#### Nim (GDExtension) Side

See **[NimSideTester](https://github.com/panno8M/godot-nim/tree/main/test/src/nimSideTester.nim)**

* Define Extension-Class
* Define **Simple** Extension-Class method
* Define Extension-Class property
* Define/Emit Extension-Class signal
* Instantiate Engine-Class
* Call Engine-Class method (E.g. `Node.get_node`)
* Override virtual hooks of Engine-Class (E.g. `_ready`, `_process`)
* Call Variants' method

### ðŸŸ¡Never tested yet

* Async Dispatch

### âš«In progress

* [ ] Upgrade to v4.2
* [ ] Define utility functions (E.g. `print`)
* [ ] Register user-defined methods
  * [x] Register and call simple method
    * [x] access to self instance
    * [x] access to other arguments
    * [x] return value
  * [ ] Support varargs
  * [x] Support static
  * [ ] Support virtual
  * [ ] Support default-value
* [ ] Auto-react to typical notifications
* [ ] Define constants
  * [x] Define Variant constants
  * [ ] Define Class constants

### ðŸŸ£Planned

* Using Parallelism
* Library hot reloading
* GDScript integration
  * Static conversion from GDScript to Nim (c2nim-like converter)
  * GDScript Embedding

### ðŸ”´Still can't

* C++ backend
  * Module development

...And so on.



## Note

### Bridge between Nim's ref and Godot's Refcounted

To handle godot's RefCounted, we have defined our own GD_ref type that wraps Nim's ref type. It calls reference/unreference at the appropriate time (copy, destruction, etc.).

### Various ways to fetch Godot's object

#### Singleton

```nim
let obj1: Engine = Engine.singleton
let obj2: Engine = /Engine
```

#### Get Node

```nim
# getNode(Node, NodePath): Node
let obj1: Control = node.getNode("Control") as Control
# `/`(Node, NodePath): Node = getNode(Node, NodePath)
let obj2: Control = node/"Control" as Control
# `/`(Node, typedesc[SomeNode]): SomeNode = getNode(Node, $SomeNode) as SomeNode
let obj3: Control = node/Control
```

### Vector Swizzling

Godot-nim supports GL-like swizzling operator `.*`.

To use swizzling, please switch `-d:nimPreviewDotLikeOps`

```nim
let v: Vector3 = [0f, 1, 2]
var v_sub = v.*zxz
assert v_sub == [2f, 0, 2]
v_sub.*xy = [3f, 4]
assert v_sub == [3f, 4, 2]
assert not compiles(v_sub.*xz = [5f, 6])
```

There are four types of accessors: x, y, z, and w.

Immutable values can be obtained in any combination.

```nim
let v2 = v.*zxy
let v3 = v.*xxxxxxxxx
```

Mutable values can only be retrieved by contiguous accessors (i.e., subsets).

```nim
v.*xy = [10f, 11]
v.*yz = [12f, 13]
v.*xyz = [14f, 15, 16]
```

Though if the original value is immutable, sub-vector will be too.

```nim
assert not compiles([1, 2, 3].*xy = [10, 11])
```

Single accessor represents mutable scalar.

```nim
let s: float32 = v.*x
v.*x = 20
```

## Development

engine classes and engine variants are generated by **[generator/](https://github.com/panno8M/godot-nim/tree/main/generator)**.

## Environment

### Tested

* Arch Linux
* Ubuntu 20.04.6 LTS on Windows 11 Subsystem
